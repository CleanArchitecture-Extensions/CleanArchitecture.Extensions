
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Extensions ecosystem for Jason Taylor's Clean Architecture template.">
      
      
      
        <link rel="canonical" href="https://cleanarchitecture-extensions.github.io/CleanArchitecture.Extensions/extensions/core-pipeline-behaviors/">
      
      
        <link rel="prev" href="../core-logging-abstractions/">
      
      
        <link rel="next" href="../core-guard-clauses/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.13">
    
    
      
        <title>Core Pipeline Behaviors - CleanArchitecture.Extensions</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e359304.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#core-pipeline-behaviors" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CleanArchitecture.Extensions" class="md-header__button md-logo" aria-label="CleanArchitecture.Extensions" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CleanArchitecture.Extensions
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Core Pipeline Behaviors
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/CleanArchitecture-Extensions/CleanArchitecture.Extensions" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CleanArchitecture-Extensions/CleanArchitecture.Extensions
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../roadmap/" class="md-tabs__link">
          
  
  Roadmap

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/quickstart/" class="md-tabs__link">
          
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/architecture-fit/" class="md-tabs__link">
          
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  Extensions Catalog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../recipes/authentication/" class="md-tabs__link">
          
  
  Recipes

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../samples/" class="md-tabs__link">
        
  
    
  
  Samples

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../reference/configuration/" class="md-tabs__link">
        
  
    
  
  Reference

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../troubleshooting/" class="md-tabs__link">
        
  
    
  
  Troubleshooting

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../release-notes/" class="md-tabs__link">
        
  
    
  
  Release Notes

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CleanArchitecture.Extensions" class="md-nav__button md-logo" aria-label="CleanArchitecture.Extensions" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    CleanArchitecture.Extensions
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/CleanArchitecture-Extensions/CleanArchitecture.Extensions" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CleanArchitecture-Extensions/CleanArchitecture.Extensions
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Roadmap
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/package-blueprints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Package Blueprints
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/adoption-playbooks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adoption Playbooks
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture-fit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture Fit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/composition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Composition & Invariants
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Extensions Catalog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Extensions Catalog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-options/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Options
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Time
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-domain-events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Domain Events
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-logging-abstractions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Logging Abstractions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Core Pipeline Behaviors
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Core Pipeline Behaviors
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-the-template-already-covers" class="md-nav__link">
    <span class="md-ellipsis">
      What the template already covers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-the-core-behaviors-add" class="md-nav__link">
    <span class="md-ellipsis">
      What the Core behaviors add
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behavior-apis-core" class="md-nav__link">
    <span class="md-ellipsis">
      Behavior APIs (Core)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-pipeline-order" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended pipeline order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wiring-in-di-application-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Wiring in DI (Application layer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-backed-walkthrough-pipeline-sample" class="md-nav__link">
    <span class="md-ellipsis">
      Sample-backed walkthrough (pipeline sample)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sample-backed walkthrough (pipeline sample)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlation-flowing-into-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Correlation flowing into handlers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-warnings-on-slow-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Performance warnings on slow commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minimal-api-endpoints-exposing-the-behaviors" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal API endpoints exposing the behaviors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behavior-by-behavior-deep-dive" class="md-nav__link">
    <span class="md-ellipsis">
      Behavior-by-behavior deep dive
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Behavior-by-behavior deep dive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlationbehavior" class="md-nav__link">
    <span class="md-ellipsis">
      CorrelationBehavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loggingbehavior" class="md-nav__link">
    <span class="md-ellipsis">
      LoggingBehavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performancebehavior" class="md-nav__link">
    <span class="md-ellipsis">
      PerformanceBehavior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Real-world usage patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-world usage patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-correlating-api-requests-end-to-end" class="md-nav__link">
    <span class="md-ellipsis">
      1) Correlating API requests end-to-end
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-swapping-logging-providers-without-touching-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      2) Swapping logging providers without touching handlers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-measuring-command-performance-with-thresholds-per-feature" class="md-nav__link">
    <span class="md-ellipsis">
      3) Measuring command performance with thresholds per feature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-capturing-correlation-in-resulterror-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      4) Capturing correlation in Result/Error metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-testing-behaviors-deterministically" class="md-nav__link">
    <span class="md-ellipsis">
      5) Testing behaviors deterministically
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-reference" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration reference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ordering-and-coexistence-tips" class="md-nav__link">
    <span class="md-ellipsis">
      Ordering and coexistence tips
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-from-template-behaviors" class="md-nav__link">
    <span class="md-ellipsis">
      Migration from template behaviors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adoption-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Adoption checklist
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-docs" class="md-nav__link">
    <span class="md-ellipsis">
      Related docs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-guard-clauses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Guard Clauses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core-result-primitives/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Result Primitives
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Validation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multitenancy-core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multitenancy Core
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Recipes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Recipes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/authentication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authentication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/caching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Caching
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../samples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Samples
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release Notes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-the-template-already-covers" class="md-nav__link">
    <span class="md-ellipsis">
      What the template already covers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-the-core-behaviors-add" class="md-nav__link">
    <span class="md-ellipsis">
      What the Core behaviors add
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behavior-apis-core" class="md-nav__link">
    <span class="md-ellipsis">
      Behavior APIs (Core)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommended-pipeline-order" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended pipeline order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wiring-in-di-application-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Wiring in DI (Application layer)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-backed-walkthrough-pipeline-sample" class="md-nav__link">
    <span class="md-ellipsis">
      Sample-backed walkthrough (pipeline sample)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sample-backed walkthrough (pipeline sample)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlation-flowing-into-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Correlation flowing into handlers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-warnings-on-slow-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Performance warnings on slow commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minimal-api-endpoints-exposing-the-behaviors" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal API endpoints exposing the behaviors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#behavior-by-behavior-deep-dive" class="md-nav__link">
    <span class="md-ellipsis">
      Behavior-by-behavior deep dive
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Behavior-by-behavior deep dive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#correlationbehavior" class="md-nav__link">
    <span class="md-ellipsis">
      CorrelationBehavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loggingbehavior" class="md-nav__link">
    <span class="md-ellipsis">
      LoggingBehavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performancebehavior" class="md-nav__link">
    <span class="md-ellipsis">
      PerformanceBehavior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-usage-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Real-world usage patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real-world usage patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-correlating-api-requests-end-to-end" class="md-nav__link">
    <span class="md-ellipsis">
      1) Correlating API requests end-to-end
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-swapping-logging-providers-without-touching-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      2) Swapping logging providers without touching handlers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-measuring-command-performance-with-thresholds-per-feature" class="md-nav__link">
    <span class="md-ellipsis">
      3) Measuring command performance with thresholds per feature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-capturing-correlation-in-resulterror-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      4) Capturing correlation in Result/Error metadata
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-testing-behaviors-deterministically" class="md-nav__link">
    <span class="md-ellipsis">
      5) Testing behaviors deterministically
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-reference" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration reference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ordering-and-coexistence-tips" class="md-nav__link">
    <span class="md-ellipsis">
      Ordering and coexistence tips
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-from-template-behaviors" class="md-nav__link">
    <span class="md-ellipsis">
      Migration from template behaviors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    <span class="md-ellipsis">
      FAQ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adoption-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Adoption checklist
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-docs" class="md-nav__link">
    <span class="md-ellipsis">
      Related docs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="core-pipeline-behaviors">Core Pipeline Behaviors<a class="headerlink" href="#core-pipeline-behaviors" title="Permanent link">&para;</a></h1>
<p>The Core extension ships MediatR behaviors that drop into Jason Taylor’s Clean Architecture pipeline without breaking existing registrations. This page explains what the template already includes, why the Core behaviors add correlation- and telemetry-friendly enhancements, and how to wire, order, and use them in real projects. Examples show both the pre-processor signature (<code>IRequestPreProcessor&lt;TRequest&gt;</code>) and the standard <code>IPipelineBehavior&lt;TRequest, TResponse&gt;</code> pattern so you can stay compatible with the template’s DI setup.</p>
<h2 id="what-the-template-already-covers">What the template already covers<a class="headerlink" href="#what-the-template-already-covers" title="Permanent link">&para;</a></h2>
<p>In the template (<code>src/Application/Common/Behaviours</code>), MediatR is wired with:
- <code>LoggingBehaviour&lt;TRequest&gt;</code> (<code>IRequestPreProcessor&lt;TRequest&gt;</code>): Logs request name, user ID, and user name using <code>ILogger&lt;TRequest&gt;</code>, <code>IUser</code>, and <code>IIdentityService&gt;</code>.
- <code>UnhandledExceptionBehaviour&lt;TRequest, TResponse&gt;</code>: Catches exceptions, logs them, and rethrows.
- <code>AuthorizationBehaviour&lt;TRequest, TResponse&gt;</code>: Enforces <code>AuthorizeAttribute</code> roles/policies using <code>IUser</code> and <code>IIdentityService</code>; throws <code>UnauthorizedAccessException</code>/<code>ForbiddenAccessException</code>.
- <code>ValidationBehaviour&lt;TRequest, TResponse&gt;</code>: Runs FluentValidation validators; throws <code>ValidationException</code> when failures exist.
- <code>PerformanceBehaviour&lt;TRequest, TResponse&gt;</code>: Uses a <code>Stopwatch</code>; logs warnings via <code>ILogger&lt;TRequest&gt;</code> when elapsed time &gt; 500 ms. It does not attach correlation metadata.</p>
<p>Registration order in <code>Application.DependencyInjection</code>: pre-processor logging, then unhandled exception, authorization, validation, performance.</p>
<p>Gaps the template intentionally leaves open:
- No correlation ID propagation across logs and handlers.
- No structured logging abstraction—everything is tied to <code>ILogger&lt;T&gt;</code>.
- No toggle for performance logging or threshold configuration via options.
- No reusable logging scope that flows into other behaviors.</p>
<h2 id="what-the-core-behaviors-add">What the Core behaviors add<a class="headerlink" href="#what-the-core-behaviors-add" title="Permanent link">&para;</a></h2>
<p>The Core behaviors preserve template compatibility while adding cross-cutting concerns you need in production:
- <strong>Correlation-aware:</strong> <code>CorrelationBehavior</code> ensures <code>ILogContext.CorrelationId</code> is set (configurable factory) and pushes it into a logging scope.
- <strong>Structured logging:</strong> <code>LoggingPreProcessor&lt;TRequest&gt;</code> emits start events as a pre-processor; <code>LoggingBehavior&lt;TRequest, TResponse&gt;</code> emits handling/handled events in the pipeline. Both use <code>IAppLogger&lt;T&gt;</code> and <code>ILogContext</code> for provider-agnostic structured logs and correlation.
- <strong>Configurable performance telemetry:</strong> <code>PerformanceBehavior</code> measures elapsed time with <code>IClock</code> and warns when <code>CoreExtensionsOptions.PerformanceWarningThreshold</code> is exceeded; it can be globally disabled via <code>EnablePerformanceLogging</code>.
- <strong>Option-driven defaults:</strong> Correlation header/name, ID factory, and performance thresholds live in <code>CoreExtensionsOptions</code>.
- <strong>Provider-agnostic logging:</strong> Behaviors depend on <code>IAppLogger&lt;T&gt;</code> and <code>ILogContext</code>, making it easy to plug in Serilog, MEL, or in-memory loggers for tests.</p>
<h2 id="behavior-apis-core">Behavior APIs (Core)<a class="headerlink" href="#behavior-apis-core" title="Permanent link">&para;</a></h2>
<ul>
<li><code>CorrelationBehavior&lt;TRequest, TResponse&gt;</code> (<code>IPipelineBehavior</code>): Ensures correlation ID, pushes scope via <code>ILogContext.PushProperty</code>.</li>
<li><code>LoggingPreProcessor&lt;TRequest&gt;</code> (<code>IRequestPreProcessor&lt;TRequest&gt;</code>): Logs request start with correlation + timestamp; sets correlation if missing.</li>
<li><code>LoggingBehavior&lt;TRequest, TResponse&gt;</code> (<code>IPipelineBehavior</code>): Logs handling/end with correlation + request type; sets correlation if missing.</li>
<li><code>PerformanceBehavior&lt;TRequest, TResponse&gt;</code> (<code>IPipelineBehavior</code>): Times handler execution; warns vs. debug logs; respects <code>EnablePerformanceLogging</code> and <code>PerformanceWarningThreshold</code>.</li>
</ul>
<p>Dependencies (registered by <code>services.AddCleanArchitectureCore()</code>):
- <code>IAppLogger&lt;T&gt;</code> (logging abstraction, now backed by the built-in <code>MelAppLoggerAdapter&lt;T&gt;</code> that bridges to <code>ILogger&lt;T&gt;</code>).
- <code>ILogContext</code> (correlation scope).
- <code>IClock</code> (time source).
- <code>CoreExtensionsOptions</code> (correlation + performance settings).</p>
<h2 id="recommended-pipeline-order">Recommended pipeline order<a class="headerlink" href="#recommended-pipeline-order" title="Permanent link">&para;</a></h2>
<p>To stay compatible with the template’s semantics while adding correlation:
1) <code>CorrelationBehavior</code> (ensures correlation ID).
2) <code>LoggingPreProcessor</code> registered as <code>IRequestPreProcessor</code> (logs start) and <code>LoggingBehavior</code> registered as <code>IPipelineBehavior</code> (logs handling/end).
3) <code>UnhandledExceptionBehaviour</code> (template).
4) <code>AuthorizationBehaviour</code> (template).
5) <code>ValidationBehaviour</code> (template).
6) <code>PerformanceBehaviour</code> (measures the whole request).
7) Handler.</p>
<p>This preserves the template’s order while guaranteeing that correlation and logging scopes exist for subsequent behaviors and for performance logs.</p>
<h2 id="wiring-in-di-application-layer">Wiring in DI (Application layer)<a class="headerlink" href="#wiring-in-di-application-layer" title="Permanent link">&para;</a></h2>
<p>Use the built-in helpers to mirror template order while turning on correlation, logging, and performance metrics:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddCleanArchitectureCore</span><span class="p">();</span><span class="w"> </span><span class="c1">// IClock, ILogContext, IAppLogger adapter, DomainEvent dispatcher/tracker</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="o">&lt;</span><span class="n">CoreExtensionsOptions</span><span class="o">&gt;</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&quot;Extensions:Core&quot;</span><span class="p">));</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddMediatR</span><span class="p">(</span><span class="n">cfg</span><span class="w"> </span><span class="o">=&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">cfg</span><span class="p">.</span><span class="n">RegisterServicesFromAssembly</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetExecutingAssembly</span><span class="p">());</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="n">cfg</span><span class="p">.</span><span class="n">AddCleanArchitectureCorePipeline</span><span class="p">();</span><span class="w"> </span><span class="c1">// Correlation -&gt; Logging pre/post -&gt; Performance</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="n">cfg</span><span class="p">.</span><span class="n">AddOpenBehavior</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">UnhandledExceptionBehaviour</span><span class="o">&lt;</span><span class="p">,</span><span class="o">&gt;</span><span class="p">));</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="n">cfg</span><span class="p">.</span><span class="n">AddOpenBehavior</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">AuthorizationBehaviour</span><span class="o">&lt;</span><span class="p">,</span><span class="o">&gt;</span><span class="p">));</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="n">cfg</span><span class="p">.</span><span class="n">AddOpenBehavior</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ValidationBehaviour</span><span class="o">&lt;</span><span class="p">,</span><span class="o">&gt;</span><span class="p">));</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="p">});</span>
</code></pre></div>
- <code>MelAppLoggerAdapter&lt;T&gt;</code> bridges Core logging to <code>ILogger&lt;T&gt;</code> so you can use your existing MEL/Serilog pipeline.
- <code>LoggingPreProcessor</code> is registered as a pre-processor (start log) and <code>LoggingBehavior</code> as a pipeline behavior (handling/end log).</p>
<h2 id="sample-backed-walkthrough-pipeline-sample">Sample-backed walkthrough (pipeline sample)<a class="headerlink" href="#sample-backed-walkthrough-pipeline-sample" title="Permanent link">&para;</a></h2>
<p>The runnable sample at <code>samples/CleanArchitecture.Extensions.Core.Pipeline.Sample</code> exercises the behaviors with real endpoints.</p>
<h3 id="correlation-flowing-into-handlers">Correlation flowing into handlers<a class="headerlink" href="#correlation-flowing-into-handlers" title="Permanent link">&para;</a></h3>
<p><code>src/Application/Diagnostics/Queries/GetPipelineDiagnostics/GetPipelineDiagnostics.cs</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">var</span><span class="w"> </span><span class="n">correlationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_logContext</span><span class="p">.</span><span class="n">CorrelationId</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="n">_clock</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;N&quot;</span><span class="p">);</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">_logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span><span class="w"> </span><span class="s">$&quot;Diagnostics requested with correlation {correlationId}&quot;</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">return</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PipelineDiagnosticsDto</span><span class="p">(</span><span class="n">correlationId</span><span class="p">,</span><span class="w"> </span><span class="n">_clock</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">));</span>
</code></pre></div>
- <code>CorrelationBehavior</code> seeds <code>_logContext.CorrelationId</code>; the handler reuses it and returns it to the caller.</p>
<h3 id="performance-warnings-on-slow-commands">Performance warnings on slow commands<a class="headerlink" href="#performance-warnings-on-slow-commands" title="Permanent link">&para;</a></h3>
<p><code>src/Application/Diagnostics/Commands/SimulateWork/SimulateWork.cs</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kt">var</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">Milliseconds</span><span class="p">);</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">_logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span><span class="w"> </span><span class="s">$&quot;Simulating {delay} ms of work&quot;</span><span class="p">);</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">await</span><span class="w"> </span><span class="n">_clock</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="n">delay</span><span class="p">),</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">);</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">_logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Debug</span><span class="p">,</span><span class="w"> </span><span class="s">$&quot;Completed simulated work after {delay} ms&quot;</span><span class="p">);</span>
</code></pre></div>
- With <code>PerformanceWarningThreshold</code> set to 400 ms in <code>src/Web/appsettings.json</code>, <code>POST /api/Diagnostics/simulate?milliseconds=650</code> emits a performance warning from <code>PerformanceBehavior</code> while returning 202 Accepted.</p>
<h3 id="minimal-api-endpoints-exposing-the-behaviors">Minimal API endpoints exposing the behaviors<a class="headerlink" href="#minimal-api-endpoints-exposing-the-behaviors" title="Permanent link">&para;</a></h3>
<p><code>src/Web/Endpoints/Diagnostics.cs</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetPipelineDiagnostics</span><span class="p">(</span><span class="n">ISender</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">TypedResults</span><span class="p">.</span><span class="n">Ok</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="n">sender</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">GetPipelineDiagnosticsQuery</span><span class="p">()));</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulateWork</span><span class="p">(</span><span class="n">ISender</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">600</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="n">sender</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimulateWorkCommand</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">));</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TypedResults</span><span class="p">.</span><span class="n">Accepted</span><span class="p">(</span><span class="s">$&quot;/api/{nameof(Diagnostics)}/simulate?milliseconds={milliseconds}&quot;</span><span class="p">);</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">}</span>
</code></pre></div>
- <code>LoggingPreProcessor</code> logs start, <code>LoggingBehavior</code> logs handling/end, <code>CorrelationBehavior</code> scopes correlation, and <code>PerformanceBehavior</code> times the simulated work.</p>
<h2 id="behavior-by-behavior-deep-dive">Behavior-by-behavior deep dive<a class="headerlink" href="#behavior-by-behavior-deep-dive" title="Permanent link">&para;</a></h2>
<h3 id="correlationbehavior">CorrelationBehavior<a class="headerlink" href="#correlationbehavior" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Purpose:</strong> Ensure every request has a correlation ID flowing through <code>ILogContext</code> and attached to structured logs.</li>
<li><strong>How it works:</strong> If <code>ILogContext.CorrelationId</code> is empty, it uses <code>CoreExtensionsOptions.CorrelationIdFactory</code> (default GUID) or <code>_clock.NewGuid()</code> to create one. It pushes a property named <code>CorrelationId</code> into the logging scope via <code>ILogContext.PushProperty</code>, then calls <code>next</code>.</li>
<li><strong>Interop with web APIs:</strong> Controllers or middleware can set <code>ILogContext.CorrelationId</code> from incoming headers (e.g., <code>X-Correlation-ID</code>). The behavior preserves that value rather than overwriting it.</li>
<li><strong>Why before logging:</strong> Downstream behaviors and handlers can rely on <code>ILogContext.CorrelationId</code> being present for logs, telemetry, and Results.</li>
</ul>
<h3 id="loggingbehavior">LoggingBehavior<a class="headerlink" href="#loggingbehavior" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Purpose:</strong> Emit structured logs at start and end of request handling, carrying correlation ID and request type.</li>
<li><strong>Split start/end logging:</strong> <code>LoggingPreProcessor&lt;TRequest&gt;</code> runs as the pre-processor for start logs; <code>LoggingBehavior&lt;TRequest, TResponse&gt;</code> runs in the pipeline for handling/finished logs.</li>
<li><strong>Scope handling:</strong> Uses <code>ILogContext.PushProperty</code> to keep <code>CorrelationId</code> in scope for downstream logging and for the paired end log.</li>
<li><strong>Data logged:</strong> Request type (full name), correlation ID, start timestamp (from <code>IClock</code>), and lifecycle messages (“Starting”, “Handling”, “Handled”).</li>
<li><strong>Compatibility:</strong> Replaces the template <code>LoggingBehaviour&lt;TRequest&gt;</code>; you can still enrich logs with user info by adapting <code>IAppLogger&lt;T&gt;</code> to include user claims.</li>
</ul>
<h3 id="performancebehavior">PerformanceBehavior<a class="headerlink" href="#performancebehavior" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Purpose:</strong> Measure elapsed time for each request and emit warnings above a configurable threshold; otherwise debug-level messages.</li>
<li><strong>Config:</strong> <code>CoreExtensionsOptions.EnablePerformanceLogging</code> (bool) and <code>PerformanceWarningThreshold</code> (TimeSpan, default 500 ms).</li>
<li><strong>Correlation:</strong> Includes <code>CorrelationId</code> from <code>ILogContext</code> in logged properties.</li>
<li><strong>Clock:</strong> Uses <code>IClock</code> to allow deterministic testing with <code>FrozenClock</code>.</li>
<li><strong>Behavior:</strong> If logging is disabled, it immediately forwards to <code>next</code>. Otherwise, it records start time, invokes <code>next</code>, computes elapsed, and logs either Warn (over threshold) or Debug (under threshold).</li>
</ul>
<h2 id="real-world-usage-patterns">Real-world usage patterns<a class="headerlink" href="#real-world-usage-patterns" title="Permanent link">&para;</a></h2>
<h3 id="1-correlating-api-requests-end-to-end">1) Correlating API requests end-to-end<a class="headerlink" href="#1-correlating-api-requests-end-to-end" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CorrelationMiddleware</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">RequestDelegate</span><span class="w"> </span><span class="n">_next</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">ILogContext</span><span class="w"> </span><span class="n">_logContext</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">CoreExtensionsOptions</span><span class="w"> </span><span class="n">_options</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">CorrelationMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span><span class="w"> </span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">ILogContext</span><span class="w"> </span><span class="n">logContext</span><span class="p">,</span><span class="w"> </span><span class="n">IOptions</span><span class="o">&lt;</span><span class="n">CoreExtensionsOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">)</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">        </span><span class="n">_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">        </span><span class="n">_logContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logContext</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">        </span><span class="n">_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">Invoke</span><span class="p">(</span><span class="n">HttpContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_options</span><span class="p">.</span><span class="n">CorrelationHeaderName</span><span class="p">;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="kt">var</span><span class="w"> </span><span class="n">incoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="n">header</span><span class="p">].</span><span class="n">FirstOrDefault</span><span class="p">();</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="n">_logContext</span><span class="p">.</span><span class="n">CorrelationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="n">_options</span><span class="p">.</span><span class="n">CorrelationIdFactory</span><span class="p">()</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="n">incoming</span><span class="p">;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_logContext</span><span class="p">.</span><span class="n">PushProperty</span><span class="p">(</span><span class="s">&quot;CorrelationId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">_logContext</span><span class="p">.</span><span class="n">CorrelationId</span><span class="p">);</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="n">header</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_logContext</span><span class="p">.</span><span class="n">CorrelationId</span><span class="o">!</span><span class="p">;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nf">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="p">}</span>
</code></pre></div>
- With the middleware setting <code>ILogContext.CorrelationId</code>, <code>CorrelationBehavior</code> will reuse it, ensuring MediatR logs share the same ID.</p>
<h3 id="2-swapping-logging-providers-without-touching-handlers">2) Swapping logging providers without touching handlers<a class="headerlink" href="#2-swapping-logging-providers-without-touching-handlers" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// Adapter bridging IAppLogger&lt;T&gt; to Microsoft.Extensions.Logging</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">public</span><span class="w"> </span><span class="k">sealed</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MelAppLogger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IAppLogger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="p">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">ILogger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_logger</span><span class="p">;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">ILogContext</span><span class="w"> </span><span class="n">_context</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nf">MelAppLogger</span><span class="p">(</span><span class="n">ILogger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">ILogContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">        </span><span class="n">_logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logger</span><span class="p">;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">        </span><span class="n">_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="n">LogLevel</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="o">?</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="n">IReadOnlyDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">object?</span><span class="o">&gt;?</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="k">using</span><span class="w"> </span><span class="nn">var</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_logger</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">object?</span><span class="o">&gt;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">            </span><span class="na">[&quot;CorrelationId&quot;]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_context</span><span class="p">.</span><span class="n">CorrelationId</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="n">_logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">Map</span><span class="p">(</span><span class="n">level</span><span class="p">),</span><span class="w"> </span><span class="n">exception</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; {@props}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">properties</span><span class="p">);</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">    </span><span class="k">private</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="w"> </span><span class="n">Map</span><span class="p">(</span><span class="n">LogLevel</span><span class="w"> </span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="k">switch</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Trace</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Trace</span><span class="p">,</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Debug</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Debug</span><span class="p">,</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Information</span><span class="p">,</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span><span class="p">,</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Error</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">        </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Critical</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Critical</span><span class="p">,</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Logging</span><span class="p">.</span><span class="n">LogLevel</span><span class="p">.</span><span class="n">None</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="p">}</span>
</code></pre></div>
- Behaviors depend on <code>IAppLogger&lt;T&gt;</code>; swapping providers requires only registering a different adapter.</p>
<h3 id="3-measuring-command-performance-with-thresholds-per-feature">3) Measuring command performance with thresholds per feature<a class="headerlink" href="#3-measuring-command-performance-with-thresholds-per-feature" title="Permanent link">&para;</a></h3>
<p>If some handlers are expected to run longer, you can override options per scope:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FeaturePerformanceOptions</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">CoreExtensionsOptions</span><span class="w"> </span><span class="nf">ForReporting</span><span class="p">(</span><span class="n">CoreExtensionsOptions</span><span class="w"> </span><span class="n">baseOptions</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="k">new</span><span class="p">()</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">            </span><span class="n">CorrelationHeaderName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseOptions</span><span class="p">.</span><span class="n">CorrelationHeaderName</span><span class="p">,</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">            </span><span class="n">GuardStrategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseOptions</span><span class="p">.</span><span class="n">GuardStrategy</span><span class="p">,</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">            </span><span class="n">EnablePerformanceLogging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">            </span><span class="n">PerformanceWarningThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">            </span><span class="n">CorrelationIdFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseOptions</span><span class="p">.</span><span class="n">CorrelationIdFactory</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="p">}</span>
</code></pre></div>
Inject a feature-specific options instance where needed (e.g., using named options) if you must raise the threshold for a known long-running report generation command.</p>
<h3 id="4-capturing-correlation-in-resulterror-metadata">4) Capturing correlation in Result/Error metadata<a class="headerlink" href="#4-capturing-correlation-in-resulterror-metadata" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Guid</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Handle</span><span class="p">(</span><span class="n">CreateInvoiceCommand</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">CancellationToken</span><span class="w"> </span><span class="n">ct</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">traceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_logContext</span><span class="p">.</span><span class="n">CorrelationId</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">(</span><span class="s">&quot;N&quot;</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_customers</span><span class="p">.</span><span class="n">GetAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">,</span><span class="w"> </span><span class="n">ct</span><span class="p">);</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">customer</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="n">Failure</span><span class="o">&lt;</span><span class="n">Guid</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;invoice.customer-not-found&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Customer not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">traceId</span><span class="p">));</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">invoiceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_invoices</span><span class="p">.</span><span class="n">CreateAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">CustomerId</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">,</span><span class="w"> </span><span class="n">ct</span><span class="p">);</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">invoiceId</span><span class="p">,</span><span class="w"> </span><span class="n">traceId</span><span class="p">);</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="p">}</span>
</code></pre></div>
- Because <code>CorrelationBehavior</code> set <code>ILogContext.CorrelationId</code>, the handler can propagate the same ID into <code>Result</code>/<code>Error</code> for downstream API responses.</p>
<h3 id="5-testing-behaviors-deterministically">5) Testing behaviors deterministically<a class="headerlink" href="#5-testing-behaviors-deterministically" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="na">[Fact]</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">PerformanceBehavior_Warns_When_Over_Threshold</span><span class="p">()</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FrozenClock</span><span class="p">(</span><span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">&quot;2025-01-01T00:00:00Z&quot;</span><span class="p">));</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryAppLogger</span><span class="o">&lt;</span><span class="n">TestRequest</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InMemoryLogContext</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">CorrelationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;corr-1&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Extensions</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CoreExtensionsOptions</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">EnablePerformanceLogging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="n">PerformanceWarningThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PerformanceBehavior</span><span class="o">&lt;</span><span class="n">TestRequest</span><span class="p">,</span><span class="w"> </span><span class="n">Unit</span><span class="o">&gt;</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">);</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">behavior</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TestRequest</span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="n">Unit</span><span class="p">.</span><span class="n">Value</span><span class="p">),</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">Entries</span><span class="p">.</span><span class="n">Should</span><span class="p">().</span><span class="n">Contain</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">Level</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LogLevel</span><span class="p">.</span><span class="n">Warning</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">CorrelationId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;corr-1&quot;</span><span class="p">);</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="p">}</span>
</code></pre></div>
- <code>FrozenClock</code> and <code>InMemoryAppLogger</code> make assertions straightforward.</p>
<h2 id="configuration-reference">Configuration reference<a class="headerlink" href="#configuration-reference" title="Permanent link">&para;</a></h2>
<p><code>CoreExtensionsOptions</code> fields relevant to behaviors:
- <code>CorrelationHeaderName</code>: The header your APIs use for correlation (helps middleware + controllers align).
- <code>CorrelationIdFactory</code>: Func<string> to generate correlation IDs when absent (default GUID “N”).
- <code>EnablePerformanceLogging</code>: Toggle performance measurement.
- <code>PerformanceWarningThreshold</code>: TimeSpan for warning threshold (default 500 ms).
- <code>TraceId</code>: Optional trace ID to apply to guard/result flows (not directly used by behaviors but useful for consistency).</p>
<p>Example appsettings:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span><span class="nt">&quot;Extensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="nt">&quot;Core&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">      </span><span class="nt">&quot;CorrelationHeaderName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X-Correlation-ID&quot;</span><span class="p">,</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">      </span><span class="nt">&quot;EnablePerformanceLogging&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">      </span><span class="nt">&quot;PerformanceWarningThreshold&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;00:00:00.500&quot;</span><span class="p">,</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">      </span><span class="nt">&quot;GuardStrategy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ReturnFailure&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="p">}</span>
</code></pre></div></p>
<h2 id="ordering-and-coexistence-tips">Ordering and coexistence tips<a class="headerlink" href="#ordering-and-coexistence-tips" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Pre-processor vs. pipeline:</strong> Keep <code>LoggingPreProcessor</code> registered if you need “request started” logs before other behaviors. <code>LoggingBehavior</code> still logs “Handled” after downstream behaviors.</li>
<li><strong>Validation exceptions:</strong> If FluentValidation throws, <code>LoggingBehavior</code> will have already logged “Handling”; <code>UnhandledExceptionBehaviour</code> will log the exception. Consider adding error logs in exception middleware if you need both start/finish markers on failure.</li>
<li><strong>Multiple correlation sources:</strong> If API middleware sets <code>ILogContext.CorrelationId</code>, <code>CorrelationBehavior</code> will respect it. Avoid regenerating IDs in handlers; rely on the behavior + middleware.</li>
<li><strong>Performance scope:</strong> If you run background jobs with MediatR, performance logs will still flow; set <code>EnablePerformanceLogging = false</code> for noise-sensitive jobs or adjust thresholds.</li>
</ul>
<h2 id="migration-from-template-behaviors">Migration from template behaviors<a class="headerlink" href="#migration-from-template-behaviors" title="Permanent link">&para;</a></h2>
<ul>
<li>Replace <code>LoggingBehaviour&lt;TRequest&gt;</code> with Core <code>LoggingPreProcessor</code> + <code>LoggingBehavior</code> registrations.</li>
<li>Keep <code>UnhandledExceptionBehaviour</code>, <code>AuthorizationBehaviour</code>, and <code>ValidationBehaviour</code> as-is; Core behaviors are additive.</li>
<li>Remove <code>Stopwatch</code>-based performance behavior from the template if you want correlation-aware performance logging; Core <code>PerformanceBehavior</code> is a drop-in replacement with options.</li>
<li>Keep handler code unchanged; behaviors are registered in DI and require no handler modifications.</li>
</ul>
<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>Do I need both pre-processor and pipeline registrations?</strong> Optional but recommended for parity with the template: <code>LoggingPreProcessor</code> captures the “starting” log before other behaviors run; <code>LoggingBehavior</code> captures “handled” after all behaviors and the handler.</li>
<li><strong>Can I add request payload sampling?</strong> Wrap <code>IAppLogger&lt;T&gt;</code> to include sanitized payload summaries; keep PII concerns in mind. The behavior provides request type and correlation ID; payload logging is left to your adapter to avoid allocations and sensitivity issues.</li>
<li><strong>What about OpenTelemetry?</strong> Adapt <code>IAppLogger&lt;T&gt;</code> or <code>ILogContext</code> to bridge correlation IDs to trace/span IDs. The behaviors themselves do not depend on OTEL packages.</li>
<li><strong>Does correlation flow to domain events?</strong> If you propagate <code>ILogContext.CorrelationId</code> into <code>DomainEvent.CorrelationId</code> or <code>Result.TraceId</code> inside handlers, you can correlate across pipelines. Core behaviors set the context; you attach it to your domain events manually.</li>
</ul>
<h2 id="adoption-checklist">Adoption checklist<a class="headerlink" href="#adoption-checklist" title="Permanent link">&para;</a></h2>
<p>1) Register <code>CorrelationBehavior</code>, <code>LoggingPreProcessor</code> (pre-processor), <code>LoggingBehavior</code> (pipeline), and <code>PerformanceBehavior</code> in the Application DI layer.
2) Configure <code>CoreExtensionsOptions</code> (header name, correlation ID factory, performance threshold).
3) Provide <code>ILogContext</code> and <code>IAppLogger&lt;T&gt;</code> adapters that forward correlation scopes to your logging provider.
4) Add middleware (optional) to set <code>ILogContext.CorrelationId</code> from incoming headers and echo it back.
5) Validate ordering: ensure correlation precedes logging; ensure performance wraps handler work after validation/authorization.
6) Write a smoke test: send a request through MediatR in-memory, assert correlation ID is present in logs and performance logs respect thresholds.</p>
<h2 id="related-docs">Related docs<a class="headerlink" href="#related-docs" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../core/">Core extension overview</a> for the full package and registration guidance.</li>
<li><a href="../core-result-primitives/">Core Result Primitives</a> to see how correlation flows into results/errors.</li>
<li><a href="../core-guard-clauses/">Core Guard Clauses</a> for input validation that pairs well with these behaviors.</li>
<li><a href="../validation/">Validation extension</a> if you lean on FluentValidation behaviors alongside Core pipeline behaviors.</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 7, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.tracking", "content.code.copy", "content.tabs.link", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8d2eff1.min.js"></script>
      
    
  </body>
</html>