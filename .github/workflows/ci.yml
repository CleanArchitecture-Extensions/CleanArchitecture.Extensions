name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build-test-pack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore CleanArchitecture.Extensions.sln

      - name: Build
        run: dotnet build CleanArchitecture.Extensions.sln -c Release /p:ContinuousIntegrationBuild=true

      - name: Test
        run: dotnet test CleanArchitecture.Extensions.sln -c Release --no-build /p:ContinuousIntegrationBuild=true

      - name: Pack Caching
        run: dotnet pack src/CleanArchitecture.Extensions.Caching/CleanArchitecture.Extensions.Caching.csproj -c Release -o artifacts/packages /p:ContinuousIntegrationBuild=true

      - name: Install SourceLink CLI
        run: |
          dotnet tool install --global sourcelink
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Verify SourceLink
        run: |
          sourcelink test src/CleanArchitecture.Extensions.Caching/bin/Release/net10.0/CleanArchitecture.Extensions.Caching.pdb
